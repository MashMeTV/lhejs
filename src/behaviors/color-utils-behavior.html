<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
  window.LHEJS = window.LHEJS || {};

  /**
   * `ColorUtilsBehavior` injects a healthy dose of awesome into your page.
   *
   * In typical use, just slap some `ColorUtilsBehavior` at the top of your body:
   *
   *
   * Wham! It's all awesome now!
   *
   * @polymerBehavior
   */
  LHEJS.ColorUtilsBehavior = {
      rgb2yuv: function(rgb){
        var y,u,v;
        y = Math.floor(rgb[0] *  .299000 + rgb[1] *  .587000 + rgb[2] *  .114000);
        u = Math.floor(rgb[0] * -.168736 + rgb[1] * -.331264 + rgb[2] *  .500000 + 128);
        v = Math.floor(rgb[0] *  .500000 + rgb[1] * -.418688 + rgb[2] * -.081312 + 128);
        return [y,u,v];
      },

      yuv2rgba: function(yuv){
        var r,g,b;
        r = Math.floor(yuv[0] + 1.4075 * (yuv[2] - 128));
        g = Math.floor(yuv[0] - 0.3455 * (yuv[1] - 128) - (0.7169 * (yuv[2] - 128)));
        b = Math.floor(yuv[0] + 1.7790 * (yuv[1] - 128));
        if (r<0) r=0;
        else if (r>255) r=255;
        if (g<0) g=0;
        else if (g>255) g=255;
        if (b<0) b=0;
        else if (b>255) b=255;
        return[r,g,b,255];
      },

      canvas2YUV: function(canvas){
        console.time("canvas2YUV");

        var ctx=canvas.getContext("2d");
        var rgba_data = ctx.getImageData(0,0,this.width,this.height).data;

        var linePos = 0;
        var rowPos  = 0;

        var yuvArray = new Array(this.width);
        var line = new Array(this.height);

        console.time("canvas2YUV for")
        for(var i=0; i<rgba_data.length; i+=4){
          line[linePos] = this.rgb2yuv([rgba_data[i],rgba_data[i+1],rgba_data[i+2]])          
          linePos++
          if(linePos==this.height){
            yuvArray[rowPos] = line;
            line = new Array(this.height);
            linePos=0;
            rowPos++
          }
        }
        console.timeEnd("canvas2YUV for")
        
        //TO-DO: remove this line, is just for testing
        window.original_data = yuvArray;
        console.timeEnd("canvas2YUV");
        return yuvArray;
      },

      YUV2canvas: function(yuvArray, canvas){
        console.time("YUV2canvas")
        var ctx=canvas.getContext("2d");
        var imageData = ctx.getImageData(0,0,yuvArray.length,yuvArray[0].length)
        var pix = 0;
        var data = [];
        for(var x=0; x<yuvArray.length; x++){
          for(var y=0; y<yuvArray[0].length; y++){
            var prgba = this.yuv2rgba([yuvArray[x][y][0],yuvArray[x][y][1],yuvArray[x][y][2]])
            data.push(prgba[0]);
            data.push(prgba[1]);
            data.push(prgba[2]);
            data.push(prgba[3]);
          }
        }

        for(var i = 0; i < data.length; i+=4) {
          imageData.data[i] = data[i]
          imageData.data[i+1] = data[i+1];
          imageData.data[i+2] = data[i+2];
          imageData.data[i+3] = data[i+3];
        }

        ctx.putImageData(imageData,0,0);
        console.timeEnd("YUV2canvas")
      }
  };
</script>
